<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${chatRoomDto.partnerMember.nickname} + ' – Chat'">Steam-like Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Steam-like palette -->
    <style>
        :root{
            --bg:#1b2838; --panel:#171a21; --panel-2:#1f2f40; --line:#2a3f55;
            --card:#2a475e; --text:#ffffff; --muted:#c6d4df; --accent:#66c0f4; --accent-2:#4fa3d1;
            --me:#66c0f4; --you:#38566f;
        }
        *{ box-sizing:border-box }
        body{
            margin:0; background:var(--bg); color:var(--text);
            font:14px/1.4 -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo","Noto Sans KR", sans-serif;
        }
        .wrap{ max-width:980px; margin:0 auto; height:100vh; display:flex; flex-direction:column; }

        /* Header */
        .chat-header{
            background:linear-gradient(180deg, #1c2735 0%, #1b2838 100%);
            border-bottom:1px solid var(--line);
            padding:14px 18px; display:flex; align-items:center; gap:12px;
            position:sticky; top:0; z-index:10;
        }
        .avatar{
            width:36px; height:36px; border-radius:50%;
            background:#23364a; display:grid; place-items:center; color:var(--muted);
            border:1px solid #304a61; font-weight:600;
        }
        .title{ display:flex; flex-direction:column; gap:2px; }
        .name{ font-weight:700; }
        .status{ font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px; }
        .dot{ width:8px; height:8px; border-radius:50%; background:#6af06a; box-shadow:0 0 6px #6af06a99; }
        .status.offline .dot{ background:#8a8f99; box-shadow:none; }

        /* Messages */
        .chat{ flex:1; display:flex; flex-direction:column; overflow:hidden; }
        .scroll{
            flex:1; overflow-y:auto; padding:16px; background:
                radial-gradient(1200px 300px at 50% -10%, rgba(102,192,244,.06), transparent 60%),
                linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02));
        }
        .day-sep{
            text-align:center; margin:16px 0; color:var(--muted); font-size:12px; position:relative;
        }
        .day-sep:before,.day-sep:after{
            content:""; height:1px; background:var(--line); width:30%; position:absolute; top:50%;
        }
        .day-sep:before{ left:0 } .day-sep:after{ right:0 }

        .msg{ display:flex; gap:10px; margin:10px 0; align-items:flex-end; }
        .msg.me{ flex-direction:row-reverse; }
        .bubble{
            max-width:64%; padding:10px 12px; border-radius:14px; word-wrap:break-word; white-space:pre-wrap;
            background:var(--you); border:1px solid #3a5f7a;
        }
        .msg.me .bubble{ background:var(--me); color:#0b1a27; border:1px solid #5bb4e4; }
        .meta{ font-size:11px; color:var(--muted); margin:0 6px; }
        .msg.me .meta{ text-align:right; }

        /* Composer */
        .composer{
            border-top:1px solid var(--line);
            background:var(--panel);
            padding:10px; display:flex; gap:10px; align-items:center;
        }
        .field{
            flex:1; background:#0f1a25; border:1px solid #2b435a; border-radius:10px;
            display:flex; align-items:center; padding:6px 8px;
        }
        .field input{
            flex:1; border:none; outline:none; background:transparent; color:var(--text);
            font-size:14px; padding:6px;
        }
        .btn{
            background:var(--accent); border:none; color:#0b1a27; font-weight:700;
            padding:10px 14px; border-radius:10px; cursor:pointer;
            transition:transform .04s ease, background .2s ease;
        }
        .btn:hover{ background:var(--accent-2); transform:translateY(-1px); }

        /* Helpers */
        .hidden{ display:none; }
        .sys{ color:var(--muted); font-size:12px; text-align:center; margin:8px 0; }
        .top-loader{ text-align:center; color:var(--muted); font-size:12px; padding:6px 0; }
    </style>

    <!-- STOMP (native WebSocket 사용) -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div class="wrap">

    <!-- HEADER -->
    <header class="chat-header">
        <div class="avatar" th:text="${#strings.substring(chatRoomDto.partnerMember.nickname,0,1)}">U</div>
        <div class="title">
            <div class="name" th:text="${chatRoomDto.partnerMember.nickname}">친구 이름</div>
            <div id="connState" class="status">
                <span class="dot"></span>
                <span>Connected</span>
            </div>
        </div>
    </header>

    <!-- CHAT -->
    <section class="chat">
        <div id="messages" class="scroll">
            <div id="topLoader" class="top-loader hidden">Loading earlier messages…</div>
            <!-- 메시지들이 여기 append -->
        </div>

        <!-- COMPOSER -->
        <form id="sendForm" class="composer">
            <div class="field">
                <input id="content" type="text" placeholder="메시지를 입력하세요… (Enter=보내기, Shift+Enter=줄바꿈)" autocomplete="off" />
            </div>
            <button class="btn" type="submit">보내기</button>
        </form>
    </section>
</div>

<!-- Thymeleaf → JS 변수 -->
<script th:inline="javascript">
    const ROOM_ID = /*[[${chatRoomDto.id}]]*/ 0;
    const ME_ID   = /*[[${chatRoomDto.loginMember.id}]]*/ 0;
    const ME_NAME = /*[[${chatRoomDto.loginMember.nickname}]]*/ "Me";

    const PAGE_LIMIT = 15;

    // 커서 기반 히스토리 API
    const API_HISTORY = (ts, id) => {
        let url = `/api/chatRoom/${ROOM_ID}?limit=${PAGE_LIMIT}`;
        if (ts) url += `&prevTs=${encodeURIComponent(ts)}`;
        if (id) url += `&prevId=${id}`;
        return url;
    };

    // STOMP 경로 (설정: /pub, /sub)
    const WS_ENDPOINT = '/ws-stomp';
    const SUB_TOPIC   = `/sub/chat/${ROOM_ID}`;
    const PUB_DEST    = `/pub/chat/${ROOM_ID}/send`;
</script>

<script>
    let stomp, connected = false;
    const messagesEl = document.getElementById('messages');
    const topLoader  = document.getElementById('topLoader');
    const connState  = document.getElementById('connState');

    // 커서 (서버에서 내려준 값을 다시 보냄)
    let cursorTs = null;   // ISO string (e.g., 2025-09-09T14:10:30.123)
    let cursorId = null;   // number
    let hasPrev  = true;

    // 중복 방지
    const seen = new Set();

    // 초기 로드 → STOMP 연결
    init();

    async function init(){
        await loadHistory(/*prepend=*/false);
        scrollBottom();
        connectStomp();
        setupUX();
    }

    function setupUX(){
        // 상단 무한 스크롤
        messagesEl.addEventListener('scroll', async ()=>{
            if (messagesEl.scrollTop <= 10 && hasPrev){
                topLoader.classList.remove('hidden');
                const prevHeight = messagesEl.scrollHeight;
                await loadHistory(/*prepend=*/true);
                messagesEl.scrollTop = messagesEl.scrollHeight - prevHeight + 10;
                topLoader.classList.add('hidden');
            }
        });

        // 전송
        document.getElementById('sendForm').addEventListener('submit', (e)=>{
            e.preventDefault();
            const inp = document.getElementById('content');
            const text = inp.value;
            if (!text.trim() || !connected) return;
            stomp.send(PUB_DEST, {}, text);
            inp.value = '';
            inp.focus();
        });

        // Enter 전송, Shift+Enter 줄바꿈
        document.getElementById('content').addEventListener('keydown', (e)=>{
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('sendForm').dispatchEvent(new Event('submit'));
            }
        });
    }

    // 히스토리 로드 (커서 기반)
    async function loadHistory(prepend=false){
        try{
            const res = await fetch(API_HISTORY(cursorTs, cursorId));
            if (!res.ok){ console.warn('history load failed'); return; }

            const body = await res.json(); // {chats:[], chatPaging:{hasPrev, prevCursorTime, prevCursorId}}
            const list = Array.isArray(body?.chats) ? body.chats : [];

            if (list.length === 0 && !prepend) appendSystem('대화를 시작해보세요.');

            // 서버가 오래된→최근 순으로 반환한다고 가정 (네 서비스가 reverse해서 내려줌)
            for (const m of list){
                if (seen.has(m.id)) continue;
                seen.add(m.id);
                renderMsg(m, prepend);
            }

            // 커서 갱신
            const pg = body?.chatPaging;
            if (pg){
                hasPrev  = !!pg.hasPrev;
                cursorTs = pg.prevCursorTime || null;
                cursorId = pg.prevCursorId   ?? null;
            } else {
                hasPrev = false;
            }
        } catch(e){
            console.error(e);
        }
    }

    // STOMP 연결/구독 (native WebSocket)
    function connectStomp(){
        const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + WS_ENDPOINT;
        const socket = new WebSocket(wsUrl, ['v12.stomp','v11.stomp','v10.stomp']);
        stomp = Stomp.over(socket);
        stomp.debug = null; // 필요 시 주석처리
        stomp.heartbeat.outgoing = 10000;
        stomp.heartbeat.incoming = 10000;

        stomp.connect({}, () => {
            connected = true;
            setConn(true);

            stomp.subscribe(SUB_TOPIC, (frame)=>{
                const m = JSON.parse(frame.body); // ChatDto
                if (seen.has(m.id)) return;
                seen.add(m.id);

                const wasBottom = isAtBottom();
                renderMsg(m, /*prepend=*/false);
                if (wasBottom) scrollBottom();
            });
        }, () => {
            connected = false;
            setConn(false);
            setTimeout(connectStomp, 2000);
        });
    }

    function setConn(ok){
        if (ok){
            connState.classList.remove('offline');
            connState.lastElementChild.textContent = 'Connected';
        }else{
            connState.classList.add('offline');
            connState.lastElementChild.textContent = 'Reconnecting…';
        }
    }

    // 메시지 렌더
    let lastDay = '';
    function renderMsg(m, prepend=false){
        const ts = m.created; // ChatDto.created (LocalDateTime ISO)
        const day = new Date(ts).toDateString();
        if (day !== lastDay){
            const sep = document.createElement('div');
            sep.className = 'day-sep';
            sep.textContent = formatDay(ts);
            insert(sep, prepend);
            lastDay = day;
        }

        const row = document.createElement('div');
        row.className = 'msg' + (String(m.memberId) === String(ME_ID) ? ' me' : '');

        const av = document.createElement('div');
        av.className = 'avatar';
        av.textContent = (m.memberId === ME_ID ? ME_NAME : (/* 상대 이니셜 */ '')).slice(0,1).toUpperCase();
        if (!av.textContent) av.textContent = 'U';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = m.content;

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = fmtTime(ts);

        row.appendChild(av);
        row.appendChild(bubble);
        row.appendChild(meta);

        insert(row, prepend);
    }

    function insert(el, prepend=false){
        if (prepend){
            messagesEl.insertBefore(el, messagesEl.children[1] || null); // topLoader 다음
        }else{
            messagesEl.appendChild(el);
        }
    }

    // Helpers
    function isAtBottom(){
        return messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 8;
    }
    function scrollBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }
    function fmtTime(ts){
        const d = new Date(ts);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function formatDay(ts){
        const d = new Date(ts);
        return d.toLocaleDateString([], {year:'numeric', month:'short', day:'numeric'});
    }
    function appendSystem(text){
        const div = document.createElement('div');
        div.className = 'sys';
        div.textContent = text;
        messagesEl.appendChild(div);
    }
</script>
</body>
</html>
